<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp TechSupport</title>
 <style>
 html, body {
  margin: 0;
  padding: 0;
  height: 100%;
    background: url("https://static.wixstatic.com/media/a6967f_efae408b13fd46be84bf781ea591078b~mv2.jpg") no-repeat center center fixed;
  background-size: cover; /* mantém proporção sem esticar */

  font-family: "Segoe UI", sans-serif;
  color: #fff;
  overflow: hidden;
  position: relative;
}

body, html {
  margin: 0;
  height: 100%;
  overflow-x: hidden;
}

body::before {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-image: url("https://static.wixstatic.com/media/a6967f_efae408b13fd46be84bf781ea591078b~mv2.jpg");
  background-repeat: no-repeat;
  background-position: center center;
  background-size: cover;
  opacity: 0.15;
  z-index: -1;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  border-bottom: 1px solid #333;
}

.logo {
  height: 40px;
}

.datetime {
  font-size: 0.95rem;
}

.status-counter {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  font-weight: bold;
  font-size: 1rem;
}

.status-group {
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-ball {
  width: 14px;
  height: 14px;
  border-radius: 50%;
}

.aberto { background: rgba(255, 215, 0, 0.9); }
.resolvido { background: rgba(0, 128, 0, 0.9); }

.main {
  display: flex;
  flex-direction: column;
  height: calc(100% - 60px);
}

.half {
  flex: 1;
  padding: 15px;
  background-color: rgba(18, 18, 18, 0.7); /* fundo com transparência */
  color: #fff; /* texto branco */
  overflow-y: auto;
}

#resumo-dia {
  flex: 3; /* 60% */
}

#inputs {
  flex: 2; /* 40% */
}

h2 {
  margin-top: 0;
  border-bottom: 1px solid #444;
  padding-bottom: 5px;
}

.filters {
  margin-bottom: 10px;
}

/* Novo container flex para filtros com inputs e selects lado a lado */
.filters label {
  display: inline-flex;
  flex-direction: column;
  margin-right: 15px;
  font-size: 0.85rem;
  min-width: 90px;
}

.filters input[type="text"],
.filters input[type="date"],
.filters input[type="time"],
.filters select {
  background: #111;
  color: #fff;
  border: 1px solid #444;
  padding: 4px 6px;
  border-radius: 4px;
  font-size: 0.85rem;
  margin-top: 4px;
  width: 120px;
  box-sizing: border-box;
  transition: border-color 0.2s;
}

.filters input[type="text"]:focus,
.filters input[type="date"]:focus,
.filters input[type="time"]:focus,
.filters select:focus {
  border-color: #ffd700;
  outline: none;
}

select {
  background: #222;
  color: #fff;
  border: 1px solid #444;
  padding: 5px;
  border-radius: 4px;
  cursor: pointer;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

th, td {
  border: 1px solid #333;
  padding: 5px;
  text-align: left;
}

th {
  background-color: #1e1e1e;
}

td select {
  background: #222;
  color: #fff;
  border: none;
  width: 100%;
}

.status-filter-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.status-btn {
  padding: 5px 10px;
  border: none;
  border-radius: 4px;
  color: #000;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s;
}

.status-btn:hover {
  transform: scale(1.05);
}

.status-btn.aberto {
  background-color: rgba(255, 255, 0, 0.5);
}

.status-btn.resolvido {
  background-color: rgba(0, 255, 0, 0.5);
}

.column-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}

.column-filters input {
  background: #111;
  color: #fff;
  border: 1px solid #444;
  padding: 4px;
  border-radius: 4px;
  font-size: 0.8rem;
}

.status-aberto {
  color: rgba(255, 255, 0, 0.7); /* amarelo menos opaco */
  font-weight: bold;
  text-shadow:
    0 0 3px rgba(255, 255, 0, 0.7),
    0 0 6px rgba(255, 255, 0, 0.5);
}

.status-resolvido {
  color: rgba(0, 255, 0, 0.7); /* menos opaco */
  font-weight: bold;
  text-shadow:
    0 0 3px rgba(0, 255, 0, 0.7),
    0 0 6px rgba(0, 255, 0, 0.5);
}

#resumo-dia,
#inputs {
  opacity: 0.9;
}

.divider {
  height: 1px;
  background-color: white;
  margin: 0 40px;
  width: calc(100% - 80px);
  align-self: center; /* centraliza na direção do container flex */
  opacity: 0.8; /* opcional para suavizar */
}

  .title-container {
    position: relative;
    display: inline-block;
    font-size: 2rem;
    font-weight: bold;
    color: white;
  }
  .title-container img {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100px; /* ajuste o tamanho */
    height: auto;
    transform: translate(-50%, -50%);
    opacity: 0.2; /* opacidade para ficar atrás */
    z-index: -1;
  }

#resumo-dia table th:nth-child(6),
#resumo-dia table td:nth-child(6),
#inputs table th:nth-child(6),
#inputs table td:nth-child(6) {
  min-width: 120px;

}
.status-select {
  text-align-last: center; /* centraliza o texto selecionado */
  /* para compatibilidade */
  -moz-text-align-last: center;
  -webkit-text-align-last: center;
}

.status-select option[value="Aberto"] {
  color: yellow;
  background-color: black;
}
.status-select option[value="Resolvido"] {
  color: limegreen;
  background-color: black;
}


.status-label {
  font-weight: bold;
  min-width: 70px;
  text-align: center;
  border-radius: 4px;
  padding: 2px 6px;
  font-size: 0.9em;
}

.status-verde {
  color: #0f0;
  background-color: rgba(0, 255, 0, 0.2);
}

.status-amarelo {
  color: #ff0;
  background-color: rgba(255, 255, 0, 0.2);
}


.status-select {
  width: 20px;
  color: white;
  text-shadow: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  cursor: pointer;
  background: white url('data:image/svg+xml;utf8,<svg fill="white" height="12" viewBox="0 0 24 24" width="12" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 5px center;
  background-size: 12px;

  border-radius: 3px;
  padding-right: 20px;
  background-color: transparent; /* para fundo transparente */
}


#inputs .status-select {
  width: 120px;
 

  background-size: 12px;

  border-radius: 3px;
  padding-right: 20px;

}


td {
  display: table-cell !important;
  align-items: initial !important;
  gap: initial !important;
}


<td>
  <select class="status-select" data-linha="X" data-index="Y" data-table="inputs">
    <option value="Aberto">Aberto</option>
    <option value="Resolvido">Resolvido</option>
  </select>
  <span class="status-label status-amarelo">Aberto</span>
</td>



.filters label {
  display: inline-flex;
  align-items: center;
  gap: 6px; /* espaço entre label e select */
  margin-right: 15px; /* espaço entre grupos de filtros */
}

 </style>
 
</head>
<body>

<header>
  <img src="https://static.wixstatic.com/media/a6967f_982db5e228854134b613cf1ffab4708d~mv2.png" alt="logo" class="logo" />
  <div class="status-counter">
    <div class="status-group" style="display: flex; align-items: center;">
      <img src="https://static.wixstatic.com/media/a6967f_a73e1ebd828441a987868435e350d047~mv2.webp" alt="ícone aberto" style="width: 20px; height: 20px; margin-right: 6px;">
      <div class="status-ball aberto"></div> <!-- bola amarela -->
      <span id="abertos-count" style="margin-left: 6px;">0</span>
    </div>
    <div class="status-group" style="display: flex; align-items: center;">
      <div class="status-ball resolvido"></div> <!-- bola verde -->
      <span id="resolvidos-count" style="margin-left: 6px;">0</span>
    </div>
  </div>

  <div class="datetime" id="datetime"></div>
</header>

<div class="main">
  <section class="half" id="resumo-dia">
    <h2>Resumo Dia</h2>
    <div class="filters">
      <label>ID:
        <input type="text" id="filter-id-resumo" placeholder="Filtrar ID" />
      </label>
      <label>name:
        <input type="text" id="filter-name-resumo" placeholder="Filtrar name" />
      </label>
      <label>RESUMO:
        <input type="text" id="filter-resumo-resumo" placeholder="Filtrar RESUMO" />
      </label>
      <label>data:
        <input type="date" id="filter-data-resumo" />
      </label>
      <label>Status:
        <select id="filter-status-resumo">
          <option value="">Todos</option>
          <option value="Aberto">Aberto</option>
          <option value="Resolvido">Resolvido</option>
        </select>
      </label>
      <label>contacto:
        <input type="text" id="filter-contacto-resumo" placeholder="Filtrar contacto" />
      </label>
      <label>ID_KEYWORD:
        <input type="text" id="filter-id_keyword-resumo" placeholder="Filtrar ID_KEYWORD" />
      </label>
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>name</th><th>RESUMO</th><th>data</th><th>hora</th><th>status</th><th>contacto</th><th>ID_KEYWORD</th>
        </tr>
      </thead>
      <tbody id="tbody-resumo"></tbody>
    </table>
  </section>
  
  <br>
  <div class="divider"></div>
  
  
  
  <section class="half" id="inputs">
    <h2>Inputs</h2>
    <div class="filters">
      <label>ID:
        <input type="text" id="filter-id-inputs" placeholder="Filtrar ID" />
      </label>
      <label>name:
        <input type="text" id="filter-name-inputs" placeholder="Filtrar name" />
      </label>
      <label>RESUMO:
        <input type="text" id="filter-resumo-inputs" placeholder="Filtrar RESUMO" />
      </label>
      <label>data:
        <input type="date" id="filter-data-inputs" />
      </label>

      <label>contacto:
        <input type="text" id="filter-contacto-inputs" placeholder="Filtrar contacto" />
      </label>
      <label>keyword:
        <input type="text" id="filter-keyword-inputs" placeholder="Filtrar keyword" />
      </label>
      <label>ID_KEYWORD:
        <input type="text" id="filter-id_keyword-inputs" placeholder="Filtrar ID_KEYWORD" />
      </label>
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>name</th><th>RESUMO</th><th>data</th><th>hora</th><th>status</th><th>contacto</th><th>keyword</th><th>ID_KEYWORD</th>
        </tr>
      </thead>
      <tbody id="tbody-inputs"></tbody>
    </table>
  </section>
</div>


<script>
const SHEET_ID = '1VWRHITYxqbnW2nwzfM9nO6w61LpWpySViy3FzOugOlE';
const FOLHA3 = 'Folha3';
const RESUMO_DIA = 'resumo_dia';

function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
  return fetch(url)
    .then(res => res.text())
    .then(data => {
      const jsonData = JSON.parse(data.substr(47).slice(0, -2));
      const cols = jsonData.table.cols.map(c => c.label);
      return jsonData.table.rows.map(r => {
        const obj = {};
        r.c.forEach((cell, i) => {
          if (cell && typeof cell.v === 'string' && cell.v.startsWith('Date')) {
            const m = cell.v.match(/Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)/);
            if (m) {
              const y = m[1];
              const mo = Number(m[2]) + 1;
              const d = m[3];
              if (cols[i] === 'data') {
                obj[cols[i]] = `${y}-${String(mo).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
              } else if (cols[i] === 'hora') {
                const h = m[4] || '00';
                const mi = m[5] || '00';
                const s = m[6] || '00';
                obj[cols[i]] = `${String(h).padStart(2, '0')}:${String(mi).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
              } else {
                obj[cols[i]] = cell.v;
              }
              return;
            }
          }
          obj[cols[i]] = cell ? cell.v : '';
        });
        return obj;
      });
    });
}

function renderResumo(data) {
  const tbody = document.getElementById('tbody-resumo');
  tbody.innerHTML = '';
  data.forEach((row, index) => {
    const linhaPlanilha = index + 2;
    const status = row.status || 'Aberto';
    const colorClass = status === 'Resolvido' ? 'status-verde' : 'status-amarelo';

    tbody.innerHTML += `
      <tr>
        <td>${row.ID || ''}</td>
        <td>${row.name || ''}</td>
        <td>${row.RESUMO || ''}</td>
        <td>${row.data || ''}</td>
        <td>${row.hora || ''}</td>
        <td style="display:flex; align-items:center; gap:8px;">
          <select class="status-select" data-linha="${linhaPlanilha}" data-index="${index}" data-table="resumo">
            <option value="Aberto" ${status === 'Aberto' ? 'selected' : ''}>Aberto</option>
            <option value="Resolvido" ${status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
          </select>
          <span class="status-label ${colorClass}">${status}</span>
        </td>
        <td>${row.contacto || ''}</td>
        <td>${row.ID_KEYWORD || ''}</td>
      </tr>`;
  });

  tbody.querySelectorAll('.status-select').forEach(select => {
    // Atualiza o texto colorido no span ao mudar o select
    const span = select.nextElementSibling;
    select.addEventListener('change', e => {
      const value = e.target.value;
      // Atualiza span
      span.textContent = value;
      span.className = 'status-label ' + (value === 'Resolvido' ? 'status-verde' : 'status-amarelo');

      // Atualiza dados locais e backend (como antes)
      const linha = parseInt(e.target.getAttribute('data-linha'));
      const idx = parseInt(e.target.getAttribute('data-index'));

      resumoDiaData[idx].status = value;
      updateCounters();

      fetch('https://script.google.com/macros/s/AKfycbwVdPwHaTDcndGLoHrqZaDCB5aqJEqS1AWKZzhyoQmJSBFzRVTX8ODPmNzRhXgeFBfCyQ/exec', {
        method: 'POST',
        body: JSON.stringify({action: "update", linha: linha, status: value}),
        headers: {'Content-Type': 'application/json'}
      })
      .then(res => res.text())
      .then(text => {
        if (text === "OK") {
          console.log(`Status atualizado na linha ${linha}`);
        } else {
          console.error('Erro ao atualizar status:', text);
        }
      })
      .catch(err => {
        console.error('Erro na requisição:', err);
      });
    });
  });
}




function renderInputs(data) {
  const tbody = document.getElementById('tbody-inputs');
  tbody.innerHTML = '';

  // Aplica filtro de status
  const filtroStatus = document.querySelector('.inputs-status-filter.active')?.getAttribute('data-status');
  if (filtroStatus) {
    data = data.filter(row => row.status?.toLowerCase() === filtroStatus.toLowerCase());
  }

  data.forEach((row, index) => {
    const linhaPlanilha = index + 2;

    tbody.innerHTML += `
      <tr>
        <td>${row.ID || ''}</td>
        <td>${row.name || ''}</td>
        <td>${row.RESUMO || ''}</td>
        <td>${row.data || ''}</td>
        <td>${row.hora || ''}</td>
        <td>
          <select class="status-select" data-index="${index}" data-linha="${linhaPlanilha}" data-table="inputs">
            <option value="Aberto" ${row.status === 'Aberto' ? 'selected' : ''}>Aberto</option>
            <option value="Resolvido" ${row.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
          </select>
        </td>
        <td>${row.contacto || ''}</td>
        <td>${row.keyword || ''}</td>
        <td>${row.ID_KEYWORD || ''}</td>
      </tr>`;
  });

  tbody.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', e => {
      const idx = parseInt(e.target.getAttribute('data-index'));
      const linha = parseInt(e.target.getAttribute('data-linha'));
      const table = e.target.getAttribute('data-table');
      const value = e.target.value;

      if (table === 'inputs') {
        folha3Data[idx].status = value;

        // updateCountersInputs(); // (opcional) Atualiza contadores se tiveres algum

        // Envia alteração para backend (opcional)
        fetch('https://script.google.com/macros/s/AKfycbwVdPwHaTDcndGLoHrqZaDCB5aqJEqS1AWKZzhyoQmJSBFzRVTX8ODPmNzRhXgeFBfCyQ/exec', {
          method: 'POST',
          body: JSON.stringify({ action: "update", linha: linha, status: value, tabela: "Folha3" }),
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.text())
        .then(text => {
          if (text === "OK") {
            console.log(`Status atualizado na linha ${linha} (Inputs)`);
          } else {
            console.error('Erro ao atualizar status (Inputs):', text);
          }
        })
        .catch(err => {
          console.error('Erro na requisição (Inputs):', err);
        });
      }
    });
  });
}





function updateCounters() {
  const abertos = resumoDiaData.filter(r => r.status?.toLowerCase() === 'aberto').length;
  const resolvidos = resumoDiaData.filter(r => r.status?.toLowerCase() === 'resolvido').length;

  document.getElementById('abertos-count').textContent = abertos;
  document.getElementById('resolvidos-count').textContent = resolvidos;
}

let folha3Data = [];
let resumoDiaData = [];

function filterData(data, filters) {
  return data.filter(row => {
    for (const key in filters) {
      if (!filters[key]) continue;
      const val = String(row[key] || '').toLowerCase();
      const filterVal = filters[key].toLowerCase();
      if (key === 'status') {
        if (filterVal && val !== filterVal) return false;
      } else if (!val.includes(filterVal)) {
        return false;
      }
    }
    return true;
  });
}

function getResumoFilters() {
  return {
    ID: document.getElementById('filter-id-resumo').value.trim(),
    name: document.getElementById('filter-name-resumo').value.trim(),
    RESUMO: document.getElementById('filter-resumo-resumo').value.trim(),
    data: document.getElementById('filter-data-resumo').value.trim(),
    status: document.getElementById('filter-status-resumo').value.trim(),
    contacto: document.getElementById('filter-contacto-resumo').value.trim(),
    ID_KEYWORD: document.getElementById('filter-id_keyword-resumo').value.trim()
  };
}

function getInputsFilters() {
  return {
    ID: document.getElementById('filter-id-inputs').value.trim(),
    name: document.getElementById('filter-name-inputs').value.trim(),
    RESUMO: document.getElementById('filter-resumo-inputs').value.trim(),
    data: document.getElementById('filter-data-inputs').value.trim(),
    status: document.getElementById('filter-status-inputs').value.trim(),
    contacto: document.getElementById('filter-contacto-inputs').value.trim(),
    keyword: document.getElementById('filter-keyword-inputs').value.trim(),
    ID_KEYWORD: document.getElementById('filter-id_keyword-inputs').value.trim()
  };
}

function applyFiltersResumo() {
  const filters = getResumoFilters();
  const filtered = filterData(resumoDiaData, filters);
  renderResumo(filtered);
  updateCounters();
}

function applyFiltersInputs() {
  const filters = getInputsFilters();
  const filtered = filterData(folha3Data, filters);
  renderInputs(filtered);
}

// Atualiza data e hora no header
function updateDateTime() {
  const now = new Date();
  const options = { 
    timeZone: 'Europe/Lisbon', 
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit' 
  };
  const dateTimeString = now.toLocaleString('pt-PT', options);
  document.getElementById('datetime').textContent = dateTimeString;
}

function addFilterListeners() {
  // Inputs de texto no Resumo Dia -> escutam 'input'
  const resumoTextFilters = document.querySelectorAll('#resumo-dia .filters input');
  resumoTextFilters.forEach(input => input.addEventListener('input', applyFiltersResumo));

  // Selects (dropdowns) no Resumo Dia -> escutam 'change'
  const resumoSelectFilters = document.querySelectorAll('#resumo-dia .filters select');
  resumoSelectFilters.forEach(select => select.addEventListener('change', applyFiltersResumo));

  // Inputs de texto nos Inputs -> escutam 'input'
  const inputsTextFilters = document.querySelectorAll('#inputs .filters input');
  inputsTextFilters.forEach(input => input.addEventListener('input', applyFiltersInputs));

  // Selects (dropdowns) nos Inputs -> escutam 'change'
  const inputsSelectFilters = document.querySelectorAll('#inputs .filters select');
  inputsSelectFilters.forEach(select => select.addEventListener('change', applyFiltersInputs));
}


// Inicializa o app
async function init() {
  [resumoDiaData, folha3Data] = await Promise.all([
    fetchSheet(RESUMO_DIA),
    fetchSheet(FOLHA3)
  ]);
  applyFiltersResumo();
  applyFiltersInputs();
  updateCounters();
  updateDateTime();
  setInterval(updateDateTime, 1000);
  addFilterListeners();
}

init();


fetchSheet(RESUMO_DIA).then(data => {
  window.resumoData = data; // guarda os dados brutos para filtros posteriores
  renderResumo(data);
});

fetchSheet(FOLHA3).then(data => {
  window.inputsData = data; // guarda os dados brutos para filtros posteriores
  renderInputs(data);
});



setInterval(() => {
  location.reload();
}, 300000);
</script>


</body>
</html>
