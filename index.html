<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp TechSupport</title>
 <style>
 html, body {
  margin: 0;
  padding: 0;
  height: 100%;
    background: url("https://static.wixstatic.com/media/a6967f_efae408b13fd46be84bf781ea591078b~mv2.jpg") no-repeat center center fixed;
  background-size: cover; /* mantém proporção sem esticar */

  font-family: "Segoe UI", sans-serif;
  color: #fff;
  overflow: hidden;
  position: relative;
}

body, html {
  margin: 0;
  height: 100%;
  overflow-x: hidden;
}

body::before {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-image: url("https://static.wixstatic.com/media/a6967f_efae408b13fd46be84bf781ea591078b~mv2.jpg");
  background-repeat: no-repeat;
  background-position: center center;
  background-size: cover;
  opacity: 0.15;
  z-index: -1;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  border-bottom: 1px solid #333;
}

.logo {
  height: 40px;
}

.datetime {
  font-size: 0.95rem;
}

.status-counter {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  font-weight: bold;
  font-size: 1rem;
}

.status-group {
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-ball {
  width: 14px;
  height: 14px;
  border-radius: 50%;
}

.aberto { background: rgba(255, 215, 0, 0.9); }
.resolvido { background: rgba(0, 128, 0, 0.9); }

.main {
  display: flex;
  flex-direction: column;
  height: calc(100% - 60px);
}

.half {
  flex: 1;
  padding: 15px;
  background-color: rgba(18, 18, 18, 0.7); /* fundo com transparência */
  color: #fff; /* texto branco */
  overflow-y: auto;
}

#resumo-dia {
  flex: 3; /* 60% */
}

#inputs {
  flex: 2; /* 40% */
}

h2 {
  margin-top: 0;
  border-bottom: 1px solid #444;
  padding-bottom: 5px;
}

.filters {
  margin-bottom: 10px;
}

/* Novo container flex para filtros com inputs e selects lado a lado */
.filters label {
  display: inline-flex;
  flex-direction: column;
  margin-right: 15px;
  font-size: 0.85rem;
  min-width: 90px;
}

.filters input[type="text"],
.filters input[type="date"],
.filters input[type="time"],
.filters select {
  background: #111;
  color: #fff;
  border: 1px solid #444;
  padding: 4px 6px;
  border-radius: 4px;
  font-size: 0.85rem;
  margin-top: 4px;
  width: 120px;
  box-sizing: border-box;
  transition: border-color 0.2s;
}

.filters input[type="text"]:focus,
.filters input[type="date"]:focus,
.filters input[type="time"]:focus,
.filters select:focus {
  border-color: #ffd700;
  outline: none;
}

select {
  background: #222;
  color: #fff;
  border: 1px solid #444;
  padding: 5px;
  border-radius: 4px;
  cursor: pointer;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

th, td {
  border: 1px solid #333;
  padding: 5px;
  text-align: left;
}

th {
  background-color: #1e1e1e;
}

td select {
  background: #222;
  color: #fff;
  border: none;
  width: 100%;
}

.status-filter-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.status-btn {
  padding: 5px 10px;
  border: none;
  border-radius: 4px;
  color: #000;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s;
}

.status-btn:hover {
  transform: scale(1.05);
}

.status-btn.aberto {
  background-color: rgba(255, 255, 0, 0.5);
}

.status-btn.resolvido {
  background-color: rgba(0, 255, 0, 0.5);
}

.column-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}

.column-filters input {
  background: #111;
  color: #fff;
  border: 1px solid #444;
  padding: 4px;
  border-radius: 4px;
  font-size: 0.8rem;
}

.status-aberto {
  color: rgba(255, 255, 0, 0.7); /* amarelo menos opaco */
  font-weight: bold;
  text-shadow:
    0 0 3px rgba(255, 255, 0, 0.7),
    0 0 6px rgba(255, 255, 0, 0.5);
}

.status-resolvido {
  color: rgba(0, 255, 0, 0.7); /* menos opaco */
  font-weight: bold;
  text-shadow:
    0 0 3px rgba(0, 255, 0, 0.7),
    0 0 6px rgba(0, 255, 0, 0.5);
}

#resumo-dia,
#inputs {
  opacity: 0.9;
}

.divider {
  height: 1px;
  background-color: white;
  margin: 0 40px;
  width: calc(100% - 80px);
  align-self: center; /* centraliza na direção do container flex */
  opacity: 0.8; /* opcional para suavizar */
}

  .title-container {
    position: relative;
    display: inline-block;
    font-size: 2rem;
    font-weight: bold;
    color: white;
  }
  .title-container img {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100px; /* ajuste o tamanho */
    height: auto;
    transform: translate(-50%, -50%);
    opacity: 0.2; /* opacidade para ficar atrás */
    z-index: -1;
  }

.status-aberto {
  background-color: rgba(255, 255, 0, 0.5); /* amarelo neon com opacidade 0.5 */
  color: black;
  padding: 3px 8px;
  border-radius: 4px;
  font-weight: bold;
  display: inline-block;
}

.status-resolvido {
  background-color: rgba(0, 255, 0, 0.5); /* verde neon com opacidade 0.5 */
  color: black;
  padding: 3px 8px;
  border-radius: 4px;
  font-weight: bold;
  display: inline-block;
}


.status-select {
  width: 110px;
}


.atualizar-btn {
  background-color: rgba(0, 0, 0, 0.6);
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.atualizar-btn:hover {
  background-color: rgba(255, 255, 255, 0.8);
  color: black;
}


 </style>
</head>
<body>

<header>
  <img src="https://static.wixstatic.com/media/a6967f_982db5e228854134b613cf1ffab4708d~mv2.png" alt="logo" class="logo" />
<div class="status-counter">
  <div class="status-group" style="display: flex; align-items: center;">
    <img src="https://static.wixstatic.com/media/a6967f_a73e1ebd828441a987868435e350d047~mv2.webp" alt="ícone aberto" style="width: 20px; height: 20px; margin-right: 6px;">
    <div class="status-ball aberto"></div>
    <span id="abertos-count" style="margin-left: 6px;">0</span>
  </div>
  <div class="status-group" style="display: flex; align-items: center;">
    <!--<img src="https://static.wixstatic.com/media/a6967f_a73e1ebd828441a987868435e350d047~mv2.webp" alt="ícone resolvido" style="width: 20px; height: 20px; margin-right: 6px;">-->
    <div class="status-ball resolvido"></div>
    <span id="resolvidos-count" style="margin-left: 6px;">0</span>
  </div>
</div>

  <div class="datetime" id="datetime"></div>
</header>

<div class="main">
  <section class="half" id="resumo-dia">
    <h2>Resumo Dia</h2>
    <div class="filters">
      <label>ID:
        <input type="text" id="filter-id-resumo" placeholder="Filtrar ID" />
      </label>
      <label>name:
        <input type="text" id="filter-name-resumo" placeholder="Filtrar name" />
      </label>
      <label>RESUMO:
        <input type="text" id="filter-resumo-resumo" placeholder="Filtrar RESUMO" />
      </label>
      <label>data:
        <input type="date" id="filter-data-resumo" />
      </label>
     
      <label>Status:
        <select id="filter-status-resumo">
          <option value="">Todos</option>
          <option value="Aberto">Aberto</option>
          <option value="Resolvido">Resolvido</option>
        </select>
      </label>
      <label>contacto:
        <input type="text" id="filter-contacto-resumo" placeholder="Filtrar contacto" />
      </label>
      <label>ID_KEYWORD:
        <input type="text" id="filter-id_keyword-resumo" placeholder="Filtrar ID_KEYWORD" />
      </label>
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>name</th><th>RESUMO</th><th>data</th><th>hora</th><th>status</th><th>contacto</th><th>ID_KEYWORD</th>
        </tr>
      </thead>
      <tbody id="tbody-resumo"></tbody>
    </table>
  </section>
  
<br>
<div class="divider"></div>


 <section class="half" id="inputs">
  <h2>Inputs</h2>
  <div class="filters">
    <label>ID:
      <input type="text" id="filter-id-inputs" placeholder="Filtrar ID" />
    </label>
    <label>name:
      <input type="text" id="filter-name-inputs" placeholder="Filtrar name" />
    </label>
    <label>RESUMO:
      <input type="text" id="filter-resumo-inputs" placeholder="Filtrar RESUMO" />
    </label>
    <label>data:
      <input type="date" id="filter-data-inputs" />
    </label>
   
    <label>Status:
      <select id="filter-status-inputs">
        <option value="">Todos</option>
        <option value="Aberto">Aberto</option>
        <option value="Resolvido">Resolvido</option>
      </select>
    </label>
    <label>contacto:
      <input type="text" id="filter-contacto-inputs" placeholder="Filtrar contacto" />
    </label>
    <label>keyword:
      <input type="text" id="filter-keyword-inputs" placeholder="Filtrar keyword" />
    </label>
    <label>ID_KEYWORD:
      <input type="text" id="filter-id_keyword-inputs" placeholder="Filtrar ID_KEYWORD" />
    </label>
  </div>
  <table>
    <thead>
      <tr>
        <th>ID</th><th>name</th><th>RESUMO</th><th>data</th><th>hora</th><th>status</th><th>contacto</th><th>keyword</th><th>ID_KEYWORD</th>
      </tr>
    </thead>
    <tbody id="tbody-inputs"></tbody>
  </table>
</section>

 
</div>


<div id="counters" style="display:flex; gap:20px; font-weight:bold; font-size:16px; color:#fff;">
  <div>
    Aberto: <span id="abertos-count">0</span>
  </div>
  <div>
    Resolvido: <span id="resolvidos-count">0</span>
  </div>
</div>



<script>
const SHEET_ID = '1VWRHITYxqbnW2nwzfM9nO6w61LpWpySViy3FzOugOlE';
const FOLHA3 = 'Folha3';
const RESUMO_DIA = 'resumo_dia';

function formatDateISO(dateObj) {
  if (!dateObj) return '';
  if (typeof dateObj === 'string') {
    return dateObj;
  }
  if (typeof dateObj === 'object' && 'year' in dateObj && 'month' in dateObj && 'day' in dateObj) {
    const y = dateObj.year;
    const m = dateObj.month;
    const d = dateObj.day;
    return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
  }
  if (dateObj instanceof Date) {
    const y = dateObj.getFullYear();
    const m = dateObj.getMonth() + 1;
    const d = dateObj.getDate();
    return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
  }
  return dateObj;
}

function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
  return fetch(url)
    .then(res => res.text())
    .then(data => {
      const jsonData = JSON.parse(data.substr(47).slice(0, -2));
      const cols = jsonData.table.cols.map(c => c.label);
      return jsonData.table.rows.map(r => {
        const obj = {};
        r.c.forEach((cell, i) => {
          if (cell && typeof cell.v === 'string' && cell.v.startsWith('Date')) {
            const m = cell.v.match(/Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)/);
            if (m) {
              const y = m[1];
              const mo = Number(m[2]) + 1;
              const d = m[3];
              if (cols[i] === 'data') {
                obj[cols[i]] = `${y}-${String(mo).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
              } else if (cols[i] === 'hora') {
                const h = m[4] || '00';
                const mi = m[5] || '00';
                const s = m[6] || '00';
                obj[cols[i]] = `${String(h).padStart(2, '0')}:${String(mi).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
              } else {
                obj[cols[i]] = cell.v;
              }
              return;
            }
          }
          obj[cols[i]] = cell ? cell.v : '';
        });
        return obj;
      });
    });
}

function renderResumo(data) {
  const tbody = document.getElementById('tbody-resumo');
  tbody.innerHTML = '';
  data.forEach((row, index) => {
    const classeStatus = row.status === 'Aberto' ? 'status-aberto' :
                         row.status === 'Resolvido' ? 'status-resolvido' : '';

    tbody.innerHTML += `
      <tr>
        <td>${row.ID || ''}</td>
        <td>${row.name || ''}</td>
        <td>${row.RESUMO || ''}</td>
        <td>${row.data || ''}</td>
        <td>${row.hora || ''}</td>
        <td>
          <select class="status-select ${classeStatus}" data-index="${index}" data-idkeyword="${row.ID_KEYWORD}">
            <option value="Aberto" ${row.status === 'Aberto' ? 'selected' : ''}>Aberto</option>
            <option value="Resolvido" ${row.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
          </select>
   <!--<button class="atualizar-btn">Atualizar</button>-->
        </td>
        <td>${row.contacto || ''}</td>
        <td>${row.ID_KEYWORD || ''}</td>
      </tr>`;
  });

  // Após renderizar a tabela, ativa os listeners dos botões
  document.querySelectorAll('.atualizar-btn').forEach((btn, index) => {
    btn.addEventListener('click', async () => {
      const select = document.querySelectorAll('.status-select')[index];
      const novoStatus = select.value;
      const idKeyword = select.dataset.idkeyword;

      try {
        const resp = await fetch('https://h46kt34t-n8n.cloudfy.host/webhook/1ec7da22-2f56-40db-a4d1-eb8aaf3c94ca', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idKeyword, status: novoStatus })
        });

        if (!resp.ok) throw new Error('Erro na atualização');
        /*alert('Status atualizado com sucesso!');*/
      } catch (err) {
        console.error(err);
        alert('Erro ao atualizar o status');
      }
    });
  });
}

// Exemplo dos dados completos
const dadosCompletos = [
  /* seu array com os objetos da tabela */
];

// Função para filtrar e renderizar o resumo
function applyFiltersResumo() {
  const filtroStatus = document.getElementById('filter-status-resumo').value;

  let dadosFiltrados;
  if (filtroStatus === 'Todos') {
    dadosFiltrados = dadosCompletos;
  } else {
    dadosFiltrados = dadosCompletos.filter(row => row.status === filtroStatus);
  }

  renderResumo(dadosFiltrados);
}

// Definir filtro padrão "Aberto" e aplicar filtro ao carregar
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('filter-status-resumo').value = 'Aberto';
  applyFiltersResumo();

  // Atualiza a tabela ao mudar o filtro
  document.getElementById('filter-status-resumo').addEventListener('change', applyFiltersResumo);
});

function renderInputs(data) {
  const tbody = document.getElementById('tbody-inputs');
  tbody.innerHTML = '';
  data.forEach((row, index) => {
    tbody.innerHTML += `
      <tr>
        <td>${row.ID || ''}</td>
        <td>${row.name || ''}</td>
        <td>${row.RESUMO || ''}</td>
        <td>${row.data || ''}</td>
        <td>${row.hora || ''}</td>
        <td>
          <select class="status-select" data-index="${index}">
            <option value="Aberto" ${row.status === 'Aberto' ? 'selected' : ''}>Aberto</option>
            <option value="Resolvido" ${row.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
          </select>
        </td>
        <td>${row.contacto || ''}</td>
        <td>${row.keyword || ''}</td>
        <td>${row.ID_KEYWORD || ''}</td>
      </tr>`;
  });
}


function updateCounters(data) {
  const abertos = data.filter(r => r.status?.toLowerCase() === 'aberto').length;
  const resolvidos = data.filter(r => r.status?.toLowerCase() === 'resolvido').length;
  document.getElementById('abertos-count').textContent = abertos;
  document.getElementById('resolvidos-count').textContent = resolvidos;
}


let folha3Data = [];
let resumoDiaData = [];

function applyFiltersResumo() {
  const filtroStatusResumo = document.getElementById('filter-status-resumo').value.trim().toLowerCase();
  const filtroID = document.getElementById('filter-id-resumo').value.trim().toLowerCase();
  const filtroName = document.getElementById('filter-name-resumo').value.trim().toLowerCase();
  const filtroResumo = document.getElementById('filter-resumo-resumo').value.trim().toLowerCase();
  const filtroData = document.getElementById('filter-data-resumo').value;
  const filtroContacto = document.getElementById('filter-contacto-resumo').value.trim().toLowerCase();
  const filtroIDKeyword = document.getElementById('filter-id_keyword-resumo').value.trim().toLowerCase();

  const resumoFiltrado = resumoDiaData.filter(r => {
    if (filtroStatusResumo && r.status?.toLowerCase() !== filtroStatusResumo) return false;
    if (filtroID && !String(r.ID || '').toLowerCase().includes(filtroID)) return false;
    if (filtroName && !r.name?.toLowerCase().includes(filtroName)) return false;
    if (filtroResumo && !r.RESUMO?.toLowerCase().includes(filtroResumo)) return false;
    if (filtroData && r.data !== filtroData) return false;
    if (filtroContacto && !r.contacto?.toLowerCase().includes(filtroContacto)) return false;
    if (filtroIDKeyword && !r.ID_KEYWORD?.toLowerCase().includes(filtroIDKeyword)) return false;
    return true;
  });

  renderResumo(resumoFiltrado);
  updateCounters(resumoFiltrado);
}

function applyFiltersInputs() {
  const filtroStatusInputs = document.getElementById('filter-status-inputs').value.trim().toLowerCase();
  const filtroID = document.getElementById('filter-id-inputs').value.trim().toLowerCase();
  const filtroName = document.getElementById('filter-name-inputs').value.trim().toLowerCase();
  const filtroResumo = document.getElementById('filter-resumo-inputs').value.trim().toLowerCase();
  const filtroData = document.getElementById('filter-data-inputs').value;
  const filtroContacto = document.getElementById('filter-contacto-inputs').value.trim().toLowerCase();
  const filtroKeyword = document.getElementById('filter-keyword-inputs').value.trim().toLowerCase();
  const filtroIDKeyword = document.getElementById('filter-id_keyword-inputs').value.trim().toLowerCase();

  const inputsFiltrado = folha3Data.filter(r => {
    if (filtroStatusInputs && r.status?.toLowerCase() !== filtroStatusInputs) return false;
    if (filtroID && !String(r.ID || '').toLowerCase().includes(filtroID)) return false;
    if (filtroName && !r.name?.toLowerCase().includes(filtroName)) return false;
    if (filtroResumo && !r.RESUMO?.toLowerCase().includes(filtroResumo)) return false;
    if (filtroData && r.data !== filtroData) return false;
    if (filtroContacto && !r.contacto?.toLowerCase().includes(filtroContacto)) return false;
    if (filtroKeyword && !r.keyword?.toLowerCase().includes(filtroKeyword)) return false;
    if (filtroIDKeyword && !r.ID_KEYWORD?.toLowerCase().includes(filtroIDKeyword)) return false;
    return true;
  });

  renderInputs(inputsFiltrado);
}

// Eventos dos filtros Resumo Dia
[
  'filter-status-resumo', 'filter-id-resumo', 'filter-name-resumo',
  'filter-resumo-resumo', 'filter-data-resumo', 'filter-contacto-resumo',
  'filter-id_keyword-resumo'
].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', applyFiltersResumo);
});

// Eventos dos filtros Inputs
[
  'filter-status-inputs', 'filter-id-inputs', 'filter-name-inputs', 'filter-resumo-inputs',
  'filter-data-inputs', 'filter-contacto-inputs', 'filter-keyword-inputs', 'filter-id_keyword-inputs'
].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', applyFiltersInputs);
});

Promise.all([fetchSheet(FOLHA3), fetchSheet(RESUMO_DIA)])
  .then(([dadosInputs, dadosResumo]) => {
    folha3Data = dadosInputs;
    resumoDiaData = dadosResumo;
    applyFiltersResumo();
    applyFiltersInputs();
  });


document.addEventListener('change', async (event) => {
  if (event.target.classList.contains('status-select')) {
    const novoStatus = event.target.value;
    const index = Number(event.target.dataset.index);

    // Atualiza localmente no array resumoDiaData
    if (!isNaN(index) && resumoDiaData[index]) {
      resumoDiaData[index].status = novoStatus;
    }

    // Atualiza a tabela / filtros
    applyFiltersResumo();

    // Atualiza o contador com os dados filtrados atuais
    // Como applyFiltersResumo já filtra e renderiza, pode atualizar assim:
    const filtroStatusResumo = document.getElementById('filter-status-resumo').value.trim().toLowerCase();
    const filtroID = document.getElementById('filter-id-resumo').value.trim().toLowerCase();
    const filtroName = document.getElementById('filter-name-resumo').value.trim().toLowerCase();
    const filtroResumo = document.getElementById('filter-resumo-resumo').value.trim().toLowerCase();
    const filtroData = document.getElementById('filter-data-resumo').value;
    const filtroContacto = document.getElementById('filter-contacto-resumo').value.trim().toLowerCase();
    const filtroIDKeyword = document.getElementById('filter-id_keyword-resumo').value.trim().toLowerCase();

    const resumoFiltrado = resumoDiaData.filter(r => {
      if (filtroStatusResumo && r.status?.toLowerCase() !== filtroStatusResumo) return false;
      if (filtroID && !String(r.ID || '').toLowerCase().includes(filtroID)) return false;
      if (filtroName && !r.name?.toLowerCase().includes(filtroName)) return false;
      if (filtroResumo && !r.RESUMO?.toLowerCase().includes(filtroResumo)) return false;
      if (filtroData && r.data !== filtroData) return false;
      if (filtroContacto && !r.contacto?.toLowerCase().includes(filtroContacto)) return false;
      if (filtroIDKeyword && !r.ID_KEYWORD?.toLowerCase().includes(filtroIDKeyword)) return false;
      return true;
    });

    updateCounters(resumoFiltrado);

    // Aqui pode manter o webhook para atualizar planilha, se desejar
    // Exemplo:
    
        try {
        const response = await fetch('https://h46kt34t-n8n.cloudfy.host/webhook/1ec7da22-2f56-40db-a4d1-eb8aaf3c94ca', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            idKeyword: resumoDiaData[index].ID_KEYWORD,
            status: novoStatus
          })
        });

        if (!response.ok) throw new Error('Erro na atualização da planilha');
      } catch (error) {
        console.error(error);
        alert('Erro ao atualizar o status na planilha');
      }
  }
});








function updateDateTime() {
  const now = new Date();
  document.getElementById('datetime').textContent = now.toLocaleString('pt-PT');
}
updateDateTime();
setInterval(updateDateTime, 1000);

setInterval(() => {
  location.reload();
}, 300000);
</script>


</body>
</html>
